#!/bin/bash
set -e
SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
FEATURE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
FEATURE_ID="$(basename "${FEATURE_PATH}")"

# Import common utils
. "${FEATURE_PATH}/../../common/utils.sh"

set_var_to_option_value "${FEATURE_ID}" targetpath target_path "/usr/local"
set_var_to_option_value "${FEATURE_ID}" version version "latest"
set_var_to_option_value "${FEATURE_ID}" foo foo "latest"

# Skip if already run with same args
marker_path="${target_path}/etc/dev-container-features/github.com/chuxel/devcontainer-features/${FEATURE_ID}-${SCRIPT_NAME}.marker"
if ! check_marker "${marker_path}" "${target_path}" "${version}" "${foo}"; then
    echo "Foo ${version} already installed. Skipping..."
    exit 0
fi

mkdir -p "${target_path}"/bin
cat << EOF >> "${target_path}"/bin/foo
#!/bin/sh
echo "Foo!! Foo is ${foo}"
echo "TEST=\${TEST}"
echo "TEST2=\${TEST}"
EOF
chmod +x "${target_path}"/bin/foo

# Mark as complete
update_marker "${marker_path}" "${target_path}" "${version}" "${foo}"

echo "Done!"